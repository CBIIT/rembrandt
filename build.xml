<project name="caintergrator" default="build-all" basedir=".">

 <property name="props-file" value="build.properties"/>
 <property file="${props-file}"/>
 <property name="cvsRoot" value="@cbiocvs2.nci.nih.gov:/share/content/cvsroot" />
 <property name="cvsPackage" value="caintegrator" />
 <property environment="env"/>

 <patternset id="test.jars">
  <include name="junit.jar"/>  
 </patternset>	
 

 <patternset id="ojb.rt.jars">
  <include name="btree.jar"/>
  <include name="commons-beanutils.jar"/>
  <include name="commons-collections.jar"/>
  <include name="commons-dbcp.jar"/>
  <include name="commons-lang-2.0.jar"/>
  <include name="commons-logging.jar"/>  
  <include name="commons-pool.jar"/>
  <include name="db-ojb-1.0.rc4-junit.jar"/>  
  <include name="db-ojb-1.0.rc7.jar"/>
  <include name="j2ee.jar"/>
  <include name="jcs.jar"/>
  <include name="jdo.jar"/>
  <include name="jdori.jar"/>
  <include name="jta-1.0.1.jar"/>
  <include name="log4j-1.2.8.jar"/>
  <include name="p6spy.jar"/>
  
 </patternset>
	
 <patternset id="xml.jars">
 	<include name="jdom-1.0b8.jar"/>
 	<include name="jaxen-1.0-FCS-full.jar"/>
 	<include name="saxpath-1.0-FCS.jar"/>
 	<include name="xercesImpl.jar"/>
 	<include name="xmi-apis-2.0.2.jar"/>
	<include name="xdoclet-1.2b3-dev.jar"/>	
	<include name="xdoclet-ojb-module-1.2b3-dev.jar"/>	
	<include name="xml-apis.jar"/>
	<include name="xjavadoc-1.0.jar"/>	
 </patternset>
	
 <patternset id="db.platform.jars">
  <include name="oracle.jar"/>
  <include name="velocity-1.3.1.jar"/> 
 </patternset>

 <patternset id="other.jars">
  <include name="jxmldiff.jar"/>
  <include name="optional.jar"/>
 </patternset>
 
 <patternset id="struts.jars">
  <include name="commons-beanutils.jar"/>
  <include name="commons-collections.jar"/>
  <include name="commons-digester.jar"/>
  <include name="commons-fileupload.jar"/>
  <include name="commons-lang.jar"/>
  <include name="commons-logging.jar"/>
  <include name="commons-validator.jar"/>
  <include name="jakarta-oro.jar"/>
  <include name="struts.jar"/>
  <include name="struts-legacy.jar"/>
 </patternset>
 
 <patternset id="caintergrator.jars">
 <include name="caintergrator.jar"/>
 </patternset>
 
 <property file="build.properties"/>
 
 <path id="cp.compile">
    <fileset dir="${build.lib.dir}">
     <patternset refid="ojb.rt.jars"/>
     <patternset refid="db.platform.jars"/>
     <patternset refid="xml.jars"/>       
     <patternset refid="other.jars"/>
     <patternset refid="test.jars"/>	
    </fileset>
	 <fileset dir="${build.struts.lib.dir}">
     <patternset refid="struts.jars"/>    	
	 <patternset refid="caintergrator.jars"/>
    </fileset>
 </path>
 
 <path id="cp.run">
  <path refid="cp.compile"/>
  <pathelement location="${build.classes.dir}"/>
 </path>
 

   <target name="compile" > 
        <tstamp/>
        <mkdir dir="${build.dir}"/>
        <mkdir dir="${build.classes.dir}"/>
        <javac srcdir="${source.java.dir}" destdir="${build.classes.dir}" source="1.4">
        	<!-- <exclude name="**/test/*.java" /> -->
        	<exclude name="**/de/PBTest.java" /> 
        	<classpath refid="cp.compile"/>
        </javac>
	  <javac srcdir="${source.java.dir}" destdir="${build.classes.dir}" source="1.4">
        	<include name="**/de/PBTest.java" /> 
        	<classpath refid="cp.compile"/>
      </javac>
    </target>	
	
	<target name="compile_struts"> 
        <tstamp/>
         <mkdir dir="${build.struts.classes.dir}"/>     
	   	 <javac srcdir="${source.struts.dir}" destdir="${build.struts.classes.dir}">	
		 <!--<exclude name="**/form/ClinicalDataForm.java" />-->	
         <!--<exclude name="**/action/ClinicalDataAction.java" />-->		
        <classpath refid="cp.compile"/>
        </javac>


  </target>	
  <target name="build-jar" depends="compile">
	    <delete file="${jar.dir}/${app.jar.name}.jar"/>  
		<mkdir dir="${jar.dir}"/>      

		<jar index="true" jarfile="${jar.dir}/${app.jar.name}.jar">
            <fileset dir="${build.classes.dir}">
                <include name="**/*"/>
            </fileset>
        </jar>		
		<!--<delete dir="${build.classes.dir}"/>-->
	</target>
	
<target name="build-war" depends="build-jar, compile, compile_struts">
	<delete file="${build.dir}/${app.war.name}.war"/>
   <war destfile="${build.dir}/${app.war.name}.war" webxml="${webapp.dir}/WEB-INF/web.xml">
   	<fileset file="${webapp.dir}/*.jsp"/>
    <zipfileset  dir="${webapp.dir}/css" prefix="css"/>
    <zipfileset  dir="${webapp.dir}/images" prefix="images"/>
    <zipfileset  dir="${webapp.dir}/js" prefix="js"/>
    <zipfileset  dir="${webapp.dir}/jsp" prefix="jsp"/> 
   	<zipfileset  dir="${webapp.dir}/WEB-INF/resources" prefix="/WEB-INF/resources"/>

   	<webinf dir="${webapp.dir}/WEB-INF">
   	   			<include name="*.xml"/>
		   		<include name="*.properties"/>
   	   			<include name="*.tld"/>
   	            <exclude name="web.xml"/>   	
   	</webinf>
   <lib dir="${build.struts.lib.dir}">
   	<include name="${app.jar.name}.jar"/>
   	<patternset refid="struts.jars"/> 
   </lib>
   <lib dir="${build.lib.dir}">
   	<!--<patternset refid="ojb.rt.jars"/>-->
   	<exclude name="j2ee.jar"/>
   	<patternset refid="db.platform.jars"/>
   	<!-- <patternset refid="xml.jars"/> 
   	<patternset refid="other.jars"/> -->
 </lib>
 <classes dir="${build.struts.classes.dir}"/> 
  </war>
</target>

 <!--
    | Deploys the war file by copying it to the tomcat webapp directory.
    -->
    <target name="deploy-webapp" depends="build-war">
	  <delete dir="${env.CATALINA_HOME}/webapps/${app.war.name}"/>
	  <delete dir="${env.CATALINA_HOME}/work"/>
        <copy file="${build.dir}/${app.war.name}.war" todir="${env.CATALINA_HOME}/webapps"/>
    </target>

    <target name="build-all" depends="deploy-webapp"/>
 <target name="run_junit" depends="compile">

    <delete dir="${junit.report.dir}"/>
    <mkdir dir="${junit.report.dir}"/>
 	<junit printsummary="yes" fork="yes"> 	  	
 	<formatter type="plain"/>
	   
    <classpath>
		<pathelement location="${source.resource.dir}" />
		<pathelement location="build/classes" />
		<fileset dir="${build.lib.dir}">
			<include name="*.jar" />
		</fileset>			
	</classpath>	

  	<test name="gov.nih.nci.nautilus.de.PBTest"
          haltonfailure="no"
	      outfile="${junit.report.dir}/PBTest"/> 
  	</junit> 	  	
 </target>
  <!-- cvsLogin target -->
 <target name="cvs-login">
 	<delete file="${basedir}/.cvspass"/>
    <input message="Please enter CVS user login name:" addproperty="cvsLogin" />
	<condition property="noLogin"> 
		<equals arg1="" arg2="${cvsLogin}" /> 
	</condition> 
	<fail if="noLogin">You didn't enter a CVS user login name.</fail>
	<input message="Please enter CVS password:" addproperty="cvsPassword" /> 
	<condition property="noCVSPassword"> 
		<equals arg1="" arg2="${cvsPassword}" /> 
	</condition> 
	<fail if="noCVSPassword">You did not enter your CVS password.</fail>
 	 	<cvspass cvsRoot=":pserver:${cvsLogin}${cvsRoot}" password="${cvsPassword}" passfile="${basedir}/.cvspass"/> 
</target>

<!-- cvsUpdate target --> 
 <target name="cvs-update" depends="cvs-login">
 	<echoproperties prefix="cvs"/>
	<cvs cvsRoot=":pserver:${cvsLogin}${cvsRoot}" package="${cvsPackage}" dest="${basedir}/.." command="update -d" passfile="${basedir}/.cvspass"/>
 </target>

 <target name="tagcode">
	<cvs cvsRoot=":pserver:${cvsLogin}${cvsRoot}" package="${cvsPackage}" dest="${basedir}/.." command="tag -R ${tag}" passfile="${basedir}/.cvspass"/>
 </target>

 <target name="clean">       
        <delete dir="${build.dir}" quiet="true"/>
 </target> 
 
</project>
