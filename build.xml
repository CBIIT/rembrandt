<project name="caintergrator" default="build-all" basedir=".">
	<property name="props-file" value="build.properties" />
	<property file="${props-file}" />
	<property environment="env" />
	<property name="tomcat-startup-unix" location="${env.CATALINA_HOME}/bin/./startup.sh" />
	<property name="tomcat-shutdown-unix" location="${env.CATALINA_HOME}/bin/./shutdown.sh" />
	<property name="tomcat-startup-win" location="${env.CATALINA_HOME}/bin/startup.bat" />
	<property name="tomcat-shutdown-win" location="${env.CATALINA_HOME}/bin/shutdown.bat" />
	<property name="webapp.path" location="${env.CATALINA_HOME}/webapps/${app.war.name}" />
	<condition property="isUnix">
		<os name="Linux" />
	</condition>
	<condition property="isWindows">
		<os family="windows" />
	</condition>
	<!-- <echoproperties/> -->

	<patternset id="test.jars">
		<include name="junit.jar" />
	</patternset>
    <patternset id="cache.jars">
        <include name="ehcache-1.1.jar" />
    </patternset>   

	<patternset id="cabio.jars">
		<include name="caBIO21.jar" />
	</patternset>
	<patternset id="ojb.client.jars">
		<include name="commons-beanutils.jar" />
		<include name="commons-collections.jar" />
		<include name="commons-dbcp.jar" />
		<include name="commons-lang-2.0.jar" />
		<include name="commons-logging.jar" />
		<include name="commons-pool.jar" />
		<include name="db-ojb-1.0.rc4-junit.jar" />
		<include name="db-ojb-1.0.rc7.jar" />
		<include name="jcs.jar" />
		<include name="jdo.jar" />
		<include name="jdori.jar" />
		<include name="jta-1.0.1.jar" />
		<include name="log4j-1.2.8.jar" />
	</patternset>
	<patternset id="ojb.rt.jars">
		<include name="btree.jar" />
		<include name="commons-beanutils.jar" />
		<include name="commons-collections.jar" />
		<include name="commons-dbcp.jar" />
		<include name="commons-lang-2.0.jar" />
		<include name="commons-logging.jar" />
		<include name="commons-pool.jar" />
		<include name="db-ojb-1.0.rc4-junit.jar" />
		<include name="db-ojb-1.0.rc7.jar" />
		<include name="j2ee.jar" />
		<include name="jcs.jar" />
		<include name="jdo.jar" />
		<include name="jdori.jar" />
		<include name="jta-1.0.1.jar" />
		<include name="log4j-1.2.8.jar" />
		<include name="p6spy.jar" />

	</patternset>

	<patternset id="xml.jars">
		<include name="jdom-1.0b8.jar" />
		<include name="jaxen-1.0-FCS-full.jar" />
		<include name="saxpath-1.0-FCS.jar" />
		<include name="xercesImpl.jar" />
		<include name="xdoclet-1.2b3-dev.jar" />
		<include name="xdoclet-ojb-module-1.2b3-dev.jar" />
		<include name="xml-apis.jar" />
		<include name="xjavadoc-1.0.jar" />
        <include name="dom4j-1.5.2.jar" />      
        
	</patternset>

	<patternset id="db.platform.jars">
		<include name="oracle.jar" />
		<include name="velocity-1.3.1.jar" />
	</patternset>

	<patternset id="other.jars">
		<include name="jxmldiff.jar" />
		<include name="optional.jar" />
	</patternset>

	<patternset id="struts.jars">
		<include name="commons-digester.jar" />
		<include name="commons-fileupload.jar" />
		<include name="commons-validator.jar" />
		<include name="jakarta-oro.jar" />
		<include name="struts.jar" />
		<include name="struts-legacy.jar" />
	</patternset>

	<patternset id="graphic-pkg.jars">
		<include name="jfreechart-0.9.8-demo.jar" />
		<include name="jfreechart-0.9.8.jar" />
		<include name="jcommon-0.8.0.jar" />
		<include name="cewolf.jar" />
		<include name="batik-xml.jar" />
		<include name="batik-util.jar" />
		<include name="batik-svggen.jar" />
		<include name="batik-dom.jar" />
		<include name="batik-awt-util.jar" />
		<include name="krysalis-jCharts-1.0.0-alpha-1.jar" />
        <include name="dom4j-1.5.2.jar" />      

	</patternset>

	<patternset id="caintergrator.jars">
		<include name="caintergrator.jar" />
	</patternset>

	<property file="build.properties" />

	<path id="cp.compile">
		<fileset dir="${source.lib.dir}">
			<include name="cewolf.jar" />
			<include name="krysalis-jCharts-1.0.0-alpha-1.jar" />
			<include name="jfreechart-0.9.8.jar" />
			<include name="struts.jar" />
			<include name="commons-lang-2.0.jar" />
			<include name="commons-collections.jar" />
			<include name="xercesImpl.jar" />
			<include name="junit.jar" />
			<include name="log4j-1.2.8.jar" />
			<include name="db-ojb-1.0.rc7.jar" />
			<include name="dom4j-1.5.2.jar" />
            <patternset refid="cache.jars"/>         
		</fileset>
		<fileset dir="${env.CATALINA_HOME}/common/lib">
			<include name="jasper-runtime.jar" />
			<!--Needed for Tomcat 5.0 -->
			<include name="jsp-api.jar" />
			<include name="servlet-api.jar" />
			<!--Needed for Tomcat 4.0 -->
			<include name="servlet.jar" />
			
		</fileset>
	</path>

	<path id="cp.run">
		<path refid="cp.compile" />
		<pathelement location="${build.classes.dir}" />
	</path>
	<!-- precomplie JSPs -->
	<target name="jspc">
		<delete dir="${webapp.dir}/WEB-INF/src-jsp" />
		<taskdef classname="org.apache.jasper.JspC" name="jasper2">
			<classpath id="jspc.classpath">
				<pathelement location="${java.home}/../lib/tools.jar" />
				<fileset dir="${env.CATALINA_HOME}/server/lib">
					<include name="*.jar" />
				</fileset>
				<fileset dir="${env.CATALINA_HOME}/common/lib">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</taskdef>

		<jasper2 validateXml="false" uriroot="${webapp.dir}" webXmlFragment="${webapp.dir}/WEB-INF/generated_web.xml" outputDir="${webapp.dir}/WEB-INF/src-temp" />

	</target>

	<target name="precompile-jsps" depends="jspc">
		<javac destdir="${build.classes.dir}" optimize="off" failonerror="false" srcdir="${webapp.dir}/WEB-INF/src-temp" excludes="**/*.smap" debug="true" debuglevel="lines,vars,source">
			<classpath>
				<pathelement location="${webapp.path}/WEB-INF/classes" />
				<fileset dir="${build.webapp.lib.dir}">
					<include name="${app.jar.name}.jar" />
					<patternset refid="struts.jars" />
				</fileset>
				<fileset dir="${build.lib.dir}">
					<include name="xercesImpl.jar" />
					<patternset refid="ojb.client.jars" />
					<patternset refid="db.platform.jars" />
					<patternset refid="graphic-pkg.jars" />
				</fileset>
				<pathelement location="${env.CATALINA_HOME}/common/classes" />
				<fileset dir="${env.CATALINA_HOME}/common/lib">
					<include name="*.jar" />
				</fileset>
				<pathelement location="${env.CATALINA_HOME}/shared/classes" />
				<fileset dir="${env.CATALINA_HOME}/shared/lib">
					<include name="*.jar" />
				</fileset>
			</classpath>
			<include name="**" />
			<exclude name="tags/**" />
		</javac>

	</target>
	<!-- end -->

	<target name="compile">
		<tstamp />
		<mkdir dir="${build.classes.dir}" />
		<javac srcdir="${source.java.dir}" destdir="${build.classes.dir}" source="1.4" debug="true" debuglevel="lines,vars,source">
			<exclude name="**/de/PBTest.java" />
			<classpath refid="cp.compile" />
		</javac>
	</target>
	<target name="build-jar" depends="compile">
		<delete dir="${build.webapp.lib.dir}" />
		<mkdir dir="${build.webapp.lib.dir}" />
		<copy todir="${build.webapp.lib.dir}">
			<fileset dir="${source.lib.dir}">
				<patternset refid="struts.jars" />
				<patternset refid="ojb.client.jars" />
				<patternset refid="db.platform.jars" />
				<patternset refid="cabio.jars" />
				<patternset refid="graphic-pkg.jars" />
                <patternset refid="cache.jars"/>            
				<include name="xercesImpl.jar" />
				<include name="xml-apis.jar" />
			</fileset>
		</copy>
		<filter token="LOGDIR" value="${logging.dir}" />
		<copy todir="${webapp.dir}/WEB-INF/classes" filtering="true" overwrite="true">
			<fileset dir="${webapp.dir}/WEB-INF/resources">
				<include name="deToBeanAttrMappings.xml" />
				<include name="log4j.properties" />
				<include name="OJB.properties" />
				<include name="repository.dtd" />
				<include name="repository.xml" />
				<include name="repository_database.xml" />
				<include name="repository_internal.xml" />
				<include name="repository_user_caintegrator.xml" />
				<include name="label.properties" />
				<include name="ApplicationResources.properties" />
			</fileset>
		</copy>
		<!--
        <jar index="true" jarfile="${build.webapp.lib.dir}/${app.jar.name}.jar">
			<fileset dir="${build.classes.dir}">
				<include name="**/*" />
			</fileset>
		</jar>
		-->
    </target>

    <target name="build-war" depends="build-jar">
		<delete file="${build.dir}/${app.war.name}.war" />
		<war destfile="${build.dir}/${app.war.name}.war" webxml="${webapp.dir}/WEB-INF/web.xml">
			<fileset file="${webapp.dir}/*.*" />
			<zipfileset dir="${webapp.dir}/css" prefix="css" />
			<zipfileset dir="${webapp.dir}/images" prefix="images" />
			<zipfileset dir="${webapp.dir}/js" prefix="js" />
			<zipfileset dir="${webapp.dir}/jsp" prefix="jsp" />
            <zipfileset dir="${webapp.dir}/XSL" prefix="XSL" />         
			<webinf dir="${webapp.dir}/WEB-INF">
				<include name="*.xml" />
				<include name="*.properties" />
				<include name="*.tld" />
				<exclude name="web.xml" />
			</webinf>
			<lib dir="${build.webapp.lib.dir}">
				<include name="*.jar" />
            </lib>
			<classes dir="${build.webapp.classes.dir}" />
    	</war>
	</target>

	<!--
    | Deploys the war file by copying it to the tomcat webapp directory.
    -->
	<target name="deploy-webapp" depends="build-war">
		<delete dir="${webapp.path}" />
		<delete dir="${env.CATALINA_HOME}/work" />
		<copy file="${build.dir}/${app.war.name}.war" todir="${env.CATALINA_HOME}/webapps" />
	</target>
	<target name="deploy-Nautilus" depends="cvs-checkout,clean,deploy-war-n-restart-tomcat" />
	<target name="deploy-war-n-restart-tomcat" depends="tomcat-shutdown-unix,tomcat-shutdown-win,deploy-webapp,tomcat-startup-unix,tomcat-startup-win" />
	<target name="restart-tomcat-unix" if="${isUnix}" depends="tomcat-shutdown-unix,deploy-webapp,tomcat-startup-unix" />
	<target name="restart-tomcat-win" if="${isWindows}" depends="tomcat-shutdown-win,deploy-webapp,tomcat-startup-win" />
	<target name="build-all" depends="build-war" />
	<target name="run_junit" depends="compile">
		<delete dir="${junit.report.dir}" />
		<mkdir dir="${junit.report.dir}" />
		<junit printsummary="yes" fork="yes">
			<formatter type="plain" />

			<classpath>
				<pathelement location="${source.resource.dir}" />
				<pathelement location="build/classes" />
				<fileset dir="${build.lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
			<test name="gov.nih.nci.nautilus.de.PBTest" haltonfailure="no" outfile="${junit.report.dir}/PBTest" />
		</junit>
	</target>
	<!-- cvsLogin target -->
	<target name="cvs-login" unless="cvs.login.present">
		<echoproperties prefix="cvs" />
		<available file="${basedir}/.cvspass" type="file" property="cvs.login.present" />

		<delete file="${basedir}/.cvspass" />
		<!--    <input message="Please enter CVS user login name:" addproperty="cvsLogin" />
	<condition property="noLogin"> 
		<equals arg1="" arg2="${cvsLogin}" /> 
	</condition> 
	<fail if="noLogin">You didn't enter a CVS user login name.</fail> -->
		<input message="Please enter CVS password for user ${cvsUser}:" addproperty="cvsPassword" />
		<condition property="noCVSPassword">
			<equals arg1="" arg2="${cvsPassword}" />
		</condition>
		<fail if="noCVSPassword">You did not enter your CVS password.</fail>
		<cvspass cvsRoot="${cvsRoot}" password="${cvsPassword}" passfile="${basedir}/.cvspass" />
	</target>
	<target name="check-cvs-login">
		<available file="${basedir}/.cvspass" type="file" property="cvs.login.present" />
		<echoproperties prefix="cvs.login.present" />
	</target>
	<!-- cvsUpdate target -->
	<target name="cvs-update" depends="check-cvs-login, cvs-login">
		<cvs cvsRoot="${cvsRoot}" package="${cvsPackage}" dest="${basedir}/.." command="update -d" passfile="${basedir}/.cvspass" />
	</target>

	<!-- cvsUpdate checkout -->
	<target name="cvs-checkout" depends="check-cvs-login, cvs-login">
		<cvs cvsRoot="${cvsRoot}" package="${cvsPackage}" dest="${basedir}/.." command="checkout" passfile="${basedir}/.cvspass" />
	</target>
	<target name="tagcode">
		<cvs cvsRoot="${cvsRoot}" package="${cvsPackage}" dest="${basedir}/.." command="tag -R ${tag}" passfile="${basedir}/.cvspass" />
	</target>
	<!-- tomcat start-stop -->
	<target name="tomcat-shutdown-unix" if="${isUnix}">
		<exec executable="${tomcat-shutdown-unix}" spawn="true" />
	</target>
	<target name="tomcat-startup-unix" if="${isUnix}">
		<exec executable="${tomcat-startup-unix}" spawn="true" />
	</target>
	<target name="tomcat-shutdown-win" if="${isWindows}">
		<exec executable="${tomcat-shutdown-win}" spawn="true" />
	</target>
	<target name="tomcat-startup-win" if="${isWindows}">
		<exec executable="${tomcat-startup-win}" spawn="true" />
	</target>
	<target name="clean">
		<delete dir="${build.classes.dir}" quiet="true" />
	</target>
</project>
